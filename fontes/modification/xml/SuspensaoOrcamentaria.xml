<?xml version="1.0" encoding="ISO-8859-1"?>
<modification>
  <name>Suspensao Orcamentaria</name>
  <id>SuspensaoOrcamentaria</id>
  <ecidade-version>2.3.39</ecidade-version>
  <file path='forms/db_frmempautidot.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin suspensaoOrcamentaria] */]]></search>
      <add position="after">
        <![CDATA[
        
        if (isset($o47_coddot) && $o47_coddot != "") {
    
           $oDaoSuspensaoOrcamentaria = db_utils::getDao("suspensaoorcamentaria");
           $rsValidaSuspensaoOrcamentaria = $oDaoSuspensaoOrcamentaria->buscaSuspensaoDotacao($o47_coddot, db_getsession("DB_anousu"));           
           if ( $oDaoSuspensaoOrcamentaria->numrows > 0 ) {
              $lSuspenderEmpenho = db_utils::fieldsMemory($rsValidaSuspensaoOrcamentaria, 0)->suspenderempenho;
              if ($lSuspenderEmpenho == "t") {                                                                                 
                db_msgbox("Ficha financeira suspensa para empenhos.");                                                                   
                unset($o47_coddot);             
              }                                                                                
           }                                                                                                                             
        }   
        
          ]]>
      </add>
    </operation>
  </file>

  <file path='emp1_empautidot001.php'>
    <operation>
      <search><![CDATA[include("forms/db_frmempautidot.php");]]></search>
      <add position="replace">
        <![CDATA[include(Modification::getFile("forms/db_frmempautidot.php"));]]>
      </add>
    </operation>
  </file>
  
  <file path='emp4_liquidacao004.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin suspensaoOrcamentaria - Parte1] */]]></search>
      <add position="after">
        <![CDATA[
      $lSuspenderLiquidacao = false;
      if ($objJson->operacao == 1) {
        $sSqlDadosDotacaoEmpenho = "select e60_coddot 
                                      from empempenho 
                                     where e60_numemp = {$objJson->iEmpenho}";
        $iDotacao = db_utils::fieldsMemory(db_query($sSqlDadosDotacaoEmpenho), 0)->e60_coddot;
        $oDaoSuspensaoOrcamentaria = db_utils::getDao("suspensaoorcamentaria");
        $rsValidaSuspensaoOrcamentaria = $oDaoSuspensaoOrcamentaria->buscaSuspensaoDotacao($iDotacao, db_getsession("DB_anousu")); 
        if ( $oDaoSuspensaoOrcamentaria->numrows > 0 ) {
           $lSuspenderLiquidacao = db_utils::fieldsMemory($rsValidaSuspensaoOrcamentaria, 0)->suspenderliquidacao;                                                                              
        }
      }
        
    ]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[/* [Inicio plugin suspensaoOrcamentaria - Parte2] */]]></search>
      <add position="after">
        <![CDATA[
         $oEmpenho->lSuspenderLiquidacao = $lSuspenderLiquidacao;
         ]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[/* [Inicio plugin suspensaoOrcamentaria - Parte3] */]]></search>
      <add position="after">
        <![CDATA[
        $oEmpenho->lSuspenderLiquidacao = $lSuspenderLiquidacao;
        ]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[/* [Inicio plugin suspensaoOrcamentaria - Parte4] */]]></search>
      <add position="after">
        <![CDATA[
        $oEmpenho->lSuspenderLiquidacao = $lSuspenderLiquidacao;
        ]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[/* [Inicio plugin suspensaoOrcamentaria - Parte5] */]]></search>
      <add position="after">
        <![CDATA[
        $oEmpenho->lSuspenderLiquidacao = $lSuspenderLiquidacao;
        ]]>
      </add>
    </operation>

  </file>

  <file path='forms/db_frmliquida.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin suspensaoOrcamentaria - Parte1] */]]></search>
      <add position="after">
        <![CDATA[
      if (obj.lSuspenderLiquidacao == 't') {
        alert("Ficha financeira suspensa para liquidações.");
        js_pesquisa('');
        return false;
      }
    ]]>
      </add>
    </operation>
  </file>

  <file path='forms/db_frmliquidasemordem.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin suspensaoOrcamentaria - Parte1] */]]></search>
      <add position="after">
        <![CDATA[
      if (obj.lSuspenderLiquidacao == 't') {
        alert("Ficha financeira suspensa para liquidações.");
        js_pesquisa();
        return false;
      }
    ]]>
      </add>
    </operation>
  </file>

  <file path='libs/db_liborcamento.php'>
    <operation>
      <search><![CDATA[$dotacoes = " select fc_estruturaldotacao(o58_anousu,o58_coddot) as o50_estrutdespesa,]]></search>
      <add position="after">
        <![CDATA[
        o58_localizadorgastos as dl_anx,    ]]>
      </add>
    </operation>
  </file>

  <file path='func_permorcdotacao.php'>
    <operation>
      <search><![CDATA[require_once("libs/db_liborcamento.php");]]></search>
      <add position="replace">
        <![CDATA[
        require_once(modification("libs/db_liborcamento.php"));]]>
      </add>
    </operation>
  </file>

  <file path='emp4_estornaliquidacao001.php'>
    <operation>
      <search><![CDATA[require_once("libs/db_liborcamento.php");]]></search>
      <add position="replace">
        <![CDATA[
        require_once(modification("libs/db_liborcamento.php"));]]>
      </add>
    </operation>
  </file>

  <file path='emp4_manutencaoPagamentoRPC.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin suspensaoOrcamentaria - Parte1] */]]></search>
      <add position="after">
        <![CDATA[
        $lSuspenderPagamento = false;
        //empagemov para pegar o numemp
        $oDaoEmpageMov = db_utils::getDao('empagemov');
        $sSqlBuscaMovimento = $oDaoEmpageMov->sql_query_file(null, "*", null, "e81_codmov = {$iCodMov}");
        $rsBuscaMovimento   = $oDaoEmpageMov->sql_record($sSqlBuscaMovimento);
        $sNumEmp = db_utils::fieldsMemory($rsBuscaMovimento, 0)->e81_numemp;
        //empempenho para pegar o coddot
        $oDaoEmpempenho = db_utils::getDao('empempenho');
        $sSqlBuscaEmpenho = $oDaoEmpempenho->sql_query_file(null, "*", null, "e60_numemp = {$sNumEmp}");
        $rsBuscaEmpenho   = $oDaoEmpempenho->sql_record($sSqlBuscaEmpenho);
        $sCodDot = db_utils::fieldsMemory($rsBuscaEmpenho, 0)->e60_coddot;
        $sCodEmp = db_utils::fieldsMemory($rsBuscaEmpenho, 0)->e60_codemp;
        //pega o status da suspensão com o coddot
        $oDaoSuspensaoOrcamentaria = db_utils::getDao("suspensaoorcamentaria");
        $rsValidaSuspensaoOrcamentaria = $oDaoSuspensaoOrcamentaria->buscaSuspensaoDotacao($sCodDot, db_getsession("DB_anousu"));
        if ( $oDaoSuspensaoOrcamentaria->numrows > 0 ) {
           $lSuspenderPagamento = db_utils::fieldsMemory($rsValidaSuspensaoOrcamentaria, 0)->suspenderpagamento;
           $sAnexo = db_utils::fieldsMemory($rsValidaSuspensaoOrcamentaria, 0)->localizadorgastos;
           $sFonte = db_utils::fieldsMemory($rsValidaSuspensaoOrcamentaria, 0)->recurso;                                     
        }
        if ($lSuspenderPagamento == 't') {
           throw new Exception("Não foi possível realizar as configurações do pagamento referente ao empenho {$sCodEmp}. Ficha financeira do Anexo {$sAnexo} e Fonte de Recurso {$sFonte} suspensa para pagamentos.");
        }]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[/* [Inicio plugin suspensaoOrcamentaria - Parte2] */]]></search>
      <add position="after">
        <![CDATA[
      $oRetorno->lSuspenderPagamento = $lSuspenderPagamento;
      $oRetorno->sCodEmp = $sCodEmp;
      $oRetorno->sAnexo  = $sAnexo;
      $oRetorno->sFonte  = $sFonte;]]>
      </add>
    </operation>
  </file>

  <file path='emp4_pagarpagamentoRPC.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin suspensaoOrcamentaria - Parte1] */]]></search>
      <add position="after">
        <![CDATA[
          $lSuspenderPagamento = false;
          $rsOrdemPagamento = $oOrdemPagamento->getDadosOrdem();
          $oDaoSuspensaoOrcamentaria = db_utils::getDao("suspensaoorcamentaria");
          $rsValidaSuspensaoOrcamentaria = $oDaoSuspensaoOrcamentaria->buscaSuspensaoDotacao($rsOrdemPagamento->e60_coddot, db_getsession("DB_anousu"));
          if ( $oDaoSuspensaoOrcamentaria->numrows > 0 ) {
             $lSuspenderPagamento = db_utils::fieldsMemory($rsValidaSuspensaoOrcamentaria, 0)->suspenderpagamento; 
             $sAnexo = db_utils::fieldsMemory($rsValidaSuspensaoOrcamentaria, 0)->localizadorgastos; 
             $sFonte = db_utils::fieldsMemory($rsValidaSuspensaoOrcamentaria, 0)->recurso; 
          }
          if ($lSuspenderPagamento == 't') {
             throw new Exception("Não foi possível realizar o pagamento do movimento {$oMovimento->iCodMov}. Ficha financeira do Anexo {$sAnexo} e Fonte de Recurso {$sFonte} suspensa para pagamentos.");
          }]]>
      </add>
    </operation>
  </file>

</modification>
